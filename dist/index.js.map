{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import { assert } from '@ember/debug';\nimport { get } from '@ember/object';\nimport { tracked } from '@glimmer/tracking';\nimport { createCache, getValue } from '@glimmer/tracking/primitives/cache';\n\nclass Meta {\n  prevRemote;\n  peek;\n  @tracked value;\n}\n\nfunction getOrCreateMeta(instance, metas, initializer) {\n  let meta = metas.get(instance);\n\n  if (meta === undefined) {\n    meta = new Meta();\n    metas.set(instance, meta);\n\n    meta.value = meta.peek =\n      typeof initializer === 'function'\n        ? initializer.call(instance)\n        : initializer;\n  }\n\n  return meta;\n}\n\nexport function localCopy(memo, initializer) {\n  assert(\n    `@localCopy() must be given a memo path as its first argument, received \\`${String(\n      memo\n    )}\\``,\n    typeof memo === 'string'\n  );\n\n  let metas = new WeakMap();\n\n  return (/* prototype, key, desc */) => {\n    let memoFn = (obj) => get(obj, memo);\n\n    return {\n      get() {\n        let meta = getOrCreateMeta(this, metas, initializer);\n        let { prevRemote } = meta;\n\n        let incomingValue = memoFn(this, prevRemote);\n\n        if (prevRemote !== incomingValue) {\n          // If the incoming value is not the same as the previous incoming value,\n          // update the local value to match the new incoming value, and update\n          // the previous incoming value.\n          meta.value = meta.prevRemote = incomingValue;\n        }\n\n        return meta.value;\n      },\n\n      set(value) {\n        if (!metas.has(this)) {\n          let meta = getOrCreateMeta(this, metas, initializer);\n          meta.prevRemote = memoFn(this);\n          meta.value = value;\n          return;\n        }\n\n        getOrCreateMeta(this, metas, initializer).value = value;\n      },\n    };\n  };\n}\n\nexport function trackedReset(memoOrConfig) {\n  assert(\n    `@trackedReset() must be given a memo path, a memo function, or config object with a memo path or function as its first argument, received \\`${String(\n      memoOrConfig\n    )}\\``,\n    typeof memoOrConfig === 'string' ||\n      typeof memoOrConfig === 'function' ||\n      (typeof memoOrConfig === 'object' &&\n        memoOrConfig !== null &&\n        memoOrConfig.memo !== undefined)\n  );\n\n  let metas = new WeakMap();\n\n  return (_prototype, key, desc) => {\n    let memo, update;\n    let initializer = desc.initializer ?? (() => undefined);\n\n    if (typeof memoOrConfig === 'object') {\n      memo = memoOrConfig.memo;\n      update = memoOrConfig.update ?? initializer;\n    } else {\n      memo = memoOrConfig;\n      update = initializer;\n    }\n\n    let memoFn =\n      typeof memo === 'function'\n        ? (obj, last) => memo.call(obj, obj, key, last)\n        : (obj) => get(obj, memo);\n\n    return {\n      get() {\n        let meta = getOrCreateMeta(this, metas, initializer);\n        let { prevRemote } = meta;\n\n        let incomingValue = memoFn(this, prevRemote);\n\n        if (incomingValue !== prevRemote) {\n          meta.prevRemote = incomingValue;\n          meta.value = meta.peek = update.call(this, this, key, meta.peek);\n        }\n\n        return meta.value;\n      },\n\n      set(value) {\n        getOrCreateMeta(this, metas, initializer).value = value;\n      },\n    };\n  };\n}\n\nexport function cached(target, key, value) {\n  assert('@cached can only be used on getters', value && value.get);\n\n  let { get, set } = value;\n\n  let caches = new WeakMap();\n\n  return {\n    get() {\n      let cache = caches.get(this);\n\n      if (cache === undefined) {\n        cache = createCache(get.bind(this));\n        caches.set(this, cache);\n      }\n\n      return getValue(cache);\n    },\n\n    set,\n  };\n}\n\nexport function dedupeTracked() {\n  let comparator;\n  const descriptor = function (target, key, desc) {\n    let { initializer } = desc;\n    let { get, set } = tracked(target, key, desc);\n\n    let values = new WeakMap();\n\n    return {\n      get() {\n        if (!values.has(this)) {\n          let value = initializer?.call(this);\n          values.set(this, value);\n          set.call(this, value);\n        }\n\n        return get.call(this);\n      },\n\n      set(value) {\n        if (!values.has(this) || !comparator(value, values.get(this))) {\n          values.set(this, value);\n          set.call(this, value);\n        }\n      },\n    };\n  };\n  if (arguments.length === 3) {\n    comparator = (a, b) => a === b;\n    return descriptor(...arguments);\n  }\n  if (arguments.length === 1 && typeof arguments[0] === 'function') {\n    comparator = arguments[0];\n    return descriptor;\n  }\n  assert(\n    `@dedupeTracked() can either be invoked without arguments or with one comparator function, received \\`${String(\n      arguments\n    )}\\``,\n    false\n  );\n}\n"],"names":["Meta","_class","constructor","_defineProperty","_initializerDefineProperty","_descriptor","_applyDecoratedDescriptor","prototype","tracked","configurable","enumerable","writable","initializer","getOrCreateMeta","instance","metas","meta","get","undefined","set","value","peek","call","localCopy","memo","assert","String","WeakMap","memoFn","obj","prevRemote","incomingValue","has","trackedReset","memoOrConfig","_prototype","key","desc","update","last","cached","target","caches","cache","createCache","bind","getValue","dedupeTracked","comparator","descriptor","values","arguments","length","a","b"],"mappings":"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"}